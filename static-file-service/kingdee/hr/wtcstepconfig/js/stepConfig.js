"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,s=Array(t.length);e<t.length;e++)s[e]=t[e];return s}return Array.from(t)}!function(){function t(t){this.uniqueId=t.uniqueId,this.model=t.model,this.KDApi=t.KDApi,this.rootDom=t.model.dom,this.data=t.data,this.themeNum=t.themeNum,this.stack=[],this.itemIndex=0,this.timer=null,this.timer2=null,this.enterHotPart=!1,this.myTool=new KdWtcMyTool,this.langText_start=t.KDApi.getLangMsg(this.model,"start"),this.langText_end=t.KDApi.getLangMsg(this.model,"end"),this.langText_updateby=t.KDApi.getLangMsg(this.model,"updateby"),this.langText_updatedate=t.KDApi.getLangMsg(this.model,"updatedate"),this.langText_effectiveDate=t.KDApi.getLangMsg(this.model,"effectiveDate"),this.langText_desc=t.KDApi.getLangMsg(this.model,"desc"),this.langText_resultType=t.KDApi.getLangMsg(this.model,"resultType"),this.langText_calrule=t.KDApi.getLangMsg(this.model,"calrule"),this.langText_timePair=t.KDApi.getLangMsg(this.model,"timePair"),this.langText_itemValue=t.KDApi.getLangMsg(this.model,"itemValue"),this.langText_customFormula=t.KDApi.getLangMsg(this.model,"customFormula"),this.langText_customCode=t.KDApi.getLangMsg(this.model,"customCode"),this.langText_deleteConfirm=t.KDApi.getLangMsg(this.model,"deleteConfirm"),this.langText_confirm=t.KDApi.getLangMsg(this.model,"confirm"),this.langText_cancel=t.KDApi.getLangMsg(this.model,"cancel"),this.langText_warn1=t.KDApi.getLangMsg(this.model,"warn1"),this.langText_message1=t.KDApi.getLangMsg(this.model,"message1"),this.langText_message2=t.KDApi.getLangMsg(this.model,"message2"),this.langText_message3=t.KDApi.getLangMsg(this.model,"message3"),this.langText_message4=t.KDApi.getLangMsg(this.model,"message4"),this.langText_message5=t.KDApi.getLangMsg(this.model,"message5"),this.langText_message6=t.KDApi.getLangMsg(this.model,"message6"),this.langText_open=t.KDApi.getLangMsg(this.model,"open"),this.langText_superAttr=t.KDApi.getLangMsg(this.model,"superAttr"),this.langText_phase=t.KDApi.getLangMsg(this.model,"phase"),this.langText_step=t.KDApi.getLangMsg(this.model,"step"),this.langText_overwork=t.KDApi.getLangMsg(this.model,"overwork"),this.langText_phaseResultDeal=t.KDApi.getLangMsg(this.model,"phaseResultDeal"),this.langText_overlap=t.KDApi.getLangMsg(this.model,"overlap"),this.langText_merge=t.KDApi.getLangMsg(this.model,"merge"),this.langText_noReturnHandler=t.KDApi.getLangMsg(this.model,"noReturnHandler"),this.langText_continue=t.KDApi.getLangMsg(this.model,"continue"),this.langText_next=t.KDApi.getLangMsg(this.model,"next"),this.langText_break=t.KDApi.getLangMsg(this.model,"break"),this.langText_stop=t.KDApi.getLangMsg(this.model,"stop"),this.langText_error=t.KDApi.getLangMsg(this.model,"error"),this.langText_none=t.KDApi.getLangMsg(this.model,"none"),this.langText_operationConfirm=t.KDApi.getLangMsg(this.model,"operationConfirm"),this.dom_container=this.rootDom.querySelector(".wtc_stepConfig_config-container"),this.$dom_ModifyInfo=$(".wtc_stepConfig_modify-info",this.rootDom),this.$dom_openBtn=$(".wtc_stepConfig_btn-open",this.rootDom),this.$dom_foldBtn=$(".wtc_stepConfig_btn-fold",this.rootDom),this.rootDom.style.setProperty("--themeColor",this.themeNum),this.init()}t.prototype.init=function(){this.init_dom(),this.data.power&&this.init_seniorSet();var t=$(".wtc_stepConfig_item",this.rootDom),e=this.itemConnect(t);$(this.dom_container).append(e),this.eventHandle()},t.prototype.eventHandle=function(){var t=this;$(".item-main-step",t.rootDom).hover((function(){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=4}),(function(){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=3})),$(".wtc_stepConfig_step-detail-item-open",t.rootDom).click((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","inline"),$(this).css("display","none")})),$(".item-main",t.rootDom).mouseleave((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).html()&&($(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","none"),$(".wtc_stepConfig_step-detail-item-open",this.parentElement).css("display","inline"))})),t.dom_container.onclick=function(e){t.clickHandle(e.target)},t.dom_container.onmousedown=function(t){var e=t.target;"string"==typeof e.className&&e.className.includes("wtc_stepConfig_item-input")&&t.preventDefault()},this.$dom_openBtn.click((function(){$(".wtc_stepConfig_item-step",t.dom_container).each((function(e,s){"none"===$(s).css("display")&&t.openSteps(s.parentElement.querySelector(".wtc_stepConfig_item-main-text"))}))})),this.$dom_foldBtn.click((function(){$(".wtc_stepConfig_item-step",t.dom_container).each((function(e,s){"block"===$(s).css("display")&&t.foldSteps(s.parentElement.querySelector(".wtc_stepConfig_item-main-text"))}))})),$(window).on("resize.stepConfig_resize_"+this.uniqueId,(function(){0!==t.rootDom.offsetWidth&&t.refreshLine()})),$(".JNUdl1Jv").each((function(e,s){this.offsetWidth>0&&$(this).on("click.stepConfig_click_1dWRVXYw_"+t.uniqueId,(function(){setTimeout((function(){t.refreshLine()}),300)}))})),$("._2IuNtC78.hover-theme-fc").on("click.stepConfig_click_"+this.uniqueId,(function(){setTimeout((function(){0!==t.rootDom.offsetWidth&&t.refreshLine()}),20)})),0===this.data.type&&this.changeStatus(this.data.type)},t.prototype.init_dom=function(){var t="";this.$dom_ModifyInfo.html("<div>"+this.langText_updateby+"："+this.data.updateby+"</div><div>"+this.langText_updatedate+"："+this.data.updatedate+"</div>"),t+='\n             <div class="row row_0">\n                <div class="wtc_stepConfig_item wtc_stepConfig_item0">\n                    <div class="item-span-left"></div>\n                    <div class="item-main">\n                        <div class="item-main-top-dot"></div>\n                        <div class="item-main-bottom-dot"></div>\n                        <div class="wtc_stepConfig_item-fixed-text">'+this.langText_start+'</div>\n                    </div>\n                    <div class="item-span-right"></div>\n                </div>\n            </div>\n        ';for(var e=0;e<this.data.data.length;e++){this.itemIndex++,t+='\n                <div class="row row_'+(e+1)+'">\n                    <div class="wtc_stepConfig_item wtc_stepConfig_item'+this.itemIndex+'">\n                        <div class="item-span-left"></div>\n                        <div class="item-main">\n                            <div class="item-main-top-dot"></div>\n                            <div class="item-main-bottom-dot"></div>\n                            <input class="wtc_stepConfig_item-input wtc_stepConfig_item-main-text" title="'+this.data.data[e].phase+'" value="'+this.data.data[e].phase+'" readonly="true" draggable="'+(0==this.data.type)+'">\n                            <i class="wtc_stepConfig_icon-step-num" stepnum="'+this.data.data[e].steps.length+'">'+this.data.data[e].steps.length+'</i>\n                            <div class="wtc_stepConfig_icon-wrap">\n                                '+(0==this.data.type?'<i class="wtc_stepConfig_icon-set kdfont kdfont-shezhi11"></i>':"")+"\n                                "+(0==this.data.type&&this.data.data[e].del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                            </div>\n                        </div>\n                        <div class="item-span-right"></div>\n                        <div class="wtc_stepConfig_item-step">\n                            <div class="wtc_stepConfig_item-step-triangle"></div>\n                            <div class="wtc_stepConfig_item-step-triangle2"></div>\n            ';for(var s=0;s<this.data.data[e].steps.length;s++){var i=this.data.data[e].steps[s],n=i.syspreset?"kdfont-yanjing":"kdfont-shezhi11";i.desc=i.desc||this.langText_none;var a=i.desc.slice(0,48),o=i.desc.slice(48);t+='\n                    <div class="step-row step-row-'+i.id+'">\n                        <div class="step-item step-item-'+i.id+'">\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-top" style="position:absolute;top:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;z-index: 5000"></div>\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-bottom" style="position:absolute;bottom:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;z-index: 5000"></div>\n                            <div class="item-span-left"></div>\n                            <div class="item-main item-main-step">\n                                <div class="item-main-top-dot"></div>\n                                <div class="item-main-bottom-dot"></div>\n                                <input class="wtc_stepConfig_item-input wtc_stepConfig_item-step-text" value="'+i.step+'" readonly="true" draggable="'+(0==this.data.type)+'">\n                                <div class="wtc_stepConfig_step-detail">\n                                    <div class="wtc_stepConfig_step-detail-item">'+i.step+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_effectiveDate+"："+i.startdate+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_resultType+"："+("1"==i.resulttype?this.langText_timePair:this.langText_itemValue)+'</div>\n                                    \x3c!--<div class="wtc_stepConfig_step-detail-item">'+this.langText_calrule+"："+("1"==i.calrule?this.langText_customFormula:this.langText_customCode)+'</div>--\x3e\n                                    <div class="wtc_stepConfig_step-detail-item">\n                                        <span class="wtc_stepConfig_step-detail-item-first-text">'+this.langText_desc+"："+a+'</span>\n                                        <span class="wtc_stepConfig_step-detail-item-other-text">'+o+"</span>\n                                        "+(o?'<span class="wtc_stepConfig_step-detail-item-open">'+this.langText_open+"</span>":"")+'\n                                    </div>\n                                </div>\n                                <div class="wtc_stepConfig_icon-wrap">\n                                    '+(0==this.data.type?'<i class="wtc_stepConfig_icon-set kdfont '+n+'"></i>':"")+"\n                                    "+(0==this.data.type&&i.del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                                </div>\n                            </div>\n                            <div class="item-span-right"></div>\n                        </div>\n                    </div>\n                '}t+="</div></div></div>"}t+='\n             <div class="row row_'+(this.data.data.length+1)+'">\n                <div class="wtc_stepConfig_item wtc_stepConfig_item'+ ++this.itemIndex+'">\n                    <div class="item-span-left"></div>\n                    <div class="item-main">\n                        <div class="item-main-top-dot"></div>\n                        <div class="item-main-bottom-dot"></div>\n                        <div class="wtc_stepConfig_item-fixed-text">'+this.langText_end+'</div>\n                    </div>\n                    <div class="item-span-right"></div>\n                </div>\n            </div>\n        ',this.dom_container.innerHTML=t},t.prototype.init_seniorSet=function(){var t=this,e="";e+='\n        <div class="wtc_stepConfig_senior-dialog">\n            <div class="wtc_stepConfig_senior-dialog-title">'+this.langText_superAttr+'</div>\n            <div class="wtc_stepConfig_senior-dialog-phase-name">'+(this.langText_phase+this.langText_overwork)+'</div>\n            \x3c!--<div class="wtc_stepConfig_senior-dialog-set2">\n                <div class="wtc_stepConfig_senior-dialog-set-name">\n                    <span>阶段存储</span>\n                    <i class="wtc_stepConfig_senior-dialog-set-must">*</i>\n                    <i class="wtc_stepConfig_senior-dialog-set-tips kdfont kdfont-wenhao2"></i>\n                </div>\n                <a href="#" class="wtc_stepConfig_senior-dialog-select">\n                    <span class="wtc_stepConfig_senior-dialog-selected">是</span>\n                    <i class="wtc_stepConfig_senior-dialog-show-icon kdfont kdfont-shouqi7"></i>\n                    <ul class="wtc_stepConfig_senior-dialog-options">\n                        <li class="wtc_stepConfig_senior-dialog-options-item wtc_stepConfig_senior-dialog-options-item-active" index="1">是</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="0">否</li>\n                    </ul>\n                </a>\n            </div>--\x3e\n            <div class="wtc_stepConfig_senior-dialog-set1">\n                <div class="wtc_stepConfig_senior-dialog-set-name">\n                    <span>'+this.langText_phaseResultDeal+'</span>\n                    <i class="wtc_stepConfig_senior-dialog-set-must">*</i>\n                    <i class="wtc_stepConfig_senior-dialog-set-tips kdfont kdfont-wenhao2"></i>\n                </div>\n                <a href="#" class="wtc_stepConfig_senior-dialog-select">\n                    <span class="wtc_stepConfig_senior-dialog-selected">'+this.langText_overlap+'</span>\n                    <i class="wtc_stepConfig_senior-dialog-show-icon kdfont kdfont-shouqi7"></i>\n                    <ul class="wtc_stepConfig_senior-dialog-options">\n                        <li class="wtc_stepConfig_senior-dialog-options-item wtc_stepConfig_senior-dialog-options-item-active" index="0">'+this.langText_merge+'</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="1">'+this.langText_overlap+'</li>\n                    </ul>\n                </a>\n            </div>\n            <div class="wtc_stepConfig_senior-dialog-set3">\n                <div class="wtc_stepConfig_senior-dialog-set-name">\n                    <span>'+this.langText_noReturnHandler+'</span>\n                    <i class="wtc_stepConfig_senior-dialog-set-must">*</i>\n                    <i class="wtc_stepConfig_senior-dialog-set-tips kdfont kdfont-wenhao2"></i>\n                </div>\n                <a href="#" class="wtc_stepConfig_senior-dialog-select">\n                    <span class="wtc_stepConfig_senior-dialog-selected">'+this.langText_continue+'</span>\n                    <i class="wtc_stepConfig_senior-dialog-show-icon kdfont kdfont-shouqi7"></i>\n                    <ul class="wtc_stepConfig_senior-dialog-options">\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="0">'+this.langText_next+'</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item wtc_stepConfig_senior-dialog-options-item-active" index="1">'+this.langText_continue+'</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="2">'+this.langText_break+'</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="3">'+this.langText_stop+'</li>\n                        <li class="wtc_stepConfig_senior-dialog-options-item" index="4">'+this.langText_error+'</li>\n                    </ul>\n                </a>\n            </div>\n            <div class="wtc_stepConfig_senior-dialog-close kdfont kdfont-guanbi6"></div>\n        </div>\n        ',$(".wtc_stepConfig_wrap",this.rootDom).append(e);var s=$(".wtc_stepConfig_senior-dialog",this.rootDom),i=$(".wtc_stepConfig_senior-dialog-select",this.rootDom),n=$(".wtc_stepConfig_senior-dialog-set-tips",this.rootDom),a=$(".wtc_stepConfig_senior-dialog-options-item",i),o=$(".wtc_stepConfig_senior-dialog-close",this.rootDom);1==t.data.type&&s.addClass("wtc_stepConfig_senior-dialog-disabled"),o.on("click",(function(){s.hide(),$(".item-main-active",t.rootDom).removeClass("item-main-active")})),i.on("click",(function(){if(1!=t.data.type&&!$(this).parent().hasClass("wtc_stepConfig_senior-phaseResultDeal-disabled")){var e=$(".wtc_stepConfig_senior-dialog-options",this),s=$(".wtc_stepConfig_senior-dialog-show-icon",this);"none"===e.css("display")?(e.css("display","block"),s.removeClass("kdfont-shouqi7"),s.addClass("kdfont-zhankai4")):(e.css("display","none"),s.removeClass("kdfont-zhankai4"),s.addClass("kdfont-shouqi7"))}})),i.on("blur",(function(){var t=$(".wtc_stepConfig_senior-dialog-options",this),e=$(".wtc_stepConfig_senior-dialog-show-icon",this);t.css("display","none"),e.removeClass("kdfont-zhankai4"),e.addClass("kdfont-shouqi7")})),a.on("click",(function(){if(!$(this).hasClass("wtc_stepConfig_senior-dialog-options-item-active")){var e=this.innerHTML,s=$(".wtc_stepConfig_senior-dialog-selected",this.parentElement.parentElement);$(".wtc_stepConfig_senior-dialog-options-item",this.parentElement).removeClass("wtc_stepConfig_senior-dialog-options-item-active"),$(this).addClass("wtc_stepConfig_senior-dialog-options-item-active"),s.html(e);var i=$(".item-main-active",t.rootDom).parent().parent(),n=t.getDataPosition(i[0]);switch(this.parentElement.parentElement.parentElement.className){case"wtc_stepConfig_senior-dialog-set1":t.data.data[n.phaseIndex].phaseResultDeal=Number($(this).attr("index"));break;case"wtc_stepConfig_senior-dialog-set3":"phase"===n.type?t.data.data[n.phaseIndex].noReturnHandler=$(this).attr("index"):t.data.data[n.phaseIndex].steps[n.stepIndex].noReturnHandler=$(this).attr("index")}}})),n.on("mouseenter",(function(){var e=this.parentElement.parentElement.className,s="";e.includes("wtc_stepConfig_senior-dialog-set1")?s=t.data.phaseresultdeal:e.includes("wtc_stepConfig_senior-dialog-set3")&&(s=t.data.noreturnhandler);var i=function(t){let e=document.createElement("div");return e.appendChild(document.createTextNode(t)),e.innerHTML}(s);i=i.replaceAll("\\r\\n","<br>").replaceAll("\\n","<br>"),t.myTool.showPopover({target:this,isHtml:!0,data:'<div style="max-width: 500px;">'+i+"</div>"})})),n.on("mouseleave",(function(){t.myTool.cancelPopover()}))},t.prototype.refreshStatus=function(t){this.data.type!==t&&(this.data.type=t,this.changeStatus(t))},t.prototype.changeStatus=function(t){var e=this;0===t?($(".wtc_stepConfig_senior-dialog").removeClass("wtc_stepConfig_senior-dialog-disabled"),$(document).on("keyup.stepConfig_keyup_"+this.uniqueId,(function(t){if(46===t.keyCode){var s=$(".item-main-active",e.rootDom);if(s[0]&&0!==e.rootDom.offsetWidth){var i=$(".wtc_stepConfig_icon-del",s.parent());i[0]&&e.delEvent(i[0])}}90===t.keyCode&&t.ctrlKey&&0!==e.rootDom.offsetWidth&&e.backHandle()})),$(".wtc_stepConfig_span-top-bottom",e.rootDom).on({dragover:function(t){e.allowDrop(t.originalEvent,this)},dragleave:function(t){e.hideHotPart()},drop:function(t){e.drop(t.originalEvent,this)}}),$(".wtc_stepConfig_svg-wrap",e.rootDom).on({dragover:function(t){e.allowDrop(t.originalEvent,this)},dragleave:function(t){e.hideHotPart()},drop:function(t){e.drop(t.originalEvent,this)}}),$(".wtc_stepConfig_item",e.rootDom).on({dragstart:function(t){e.drag("phase",t.originalEvent)},dragend:function(){e.hideHotPart()}}),$(".step-item",e.rootDom).on({dragstart:function(t){t.stopPropagation(),e.drag("step",t.originalEvent)},dragend:function(){e.hideHotPart()}}),$(".wtc_stepConfig_item-main-text",e.rootDom).on("blur",(function(){e.modifyName_confirm(this)})),$(".wtc_stepConfig_svg-group",e.rootDom).on({mouseenter:function(){e.showAddBtn(this)},mouseleave:function(){e.hideAddBtn(this)}}),$(".item-main",e.rootDom).on({"mouseenter.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","block")},"mouseleave.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","none")}}),$(".wtc_stepConfig_item-input").prop("draggable",!0)):($(".wtc_stepConfig_senior-dialog",e.rootDom).addClass("wtc_stepConfig_senior-dialog-disabled"),$(document).off("keyup.stepConfig_keyup_"+this.uniqueId),$(e.dom_container).off("dblclick"),$(".wtc_stepConfig_span-top-bottom",e.rootDom).off(),$(".wtc_stepConfig_svg-wrap",e.rootDom).off(),$(".wtc_stepConfig_item",e.rootDom).off(),$(".step-item",e.rootDom).off(),$(".wtc_stepConfig_item-main-text",e.rootDom).off(),$(".wtc_stepConfig_svg-group",e.rootDom).off(),$(".wtc_stepConfig_item-input").prop("draggable",!1),$(".item-main",e.rootDom).off("mouseenter.showIcon"),$(".item-main",e.rootDom).off("mouseleave.showIcon"))},t.prototype.allowDrop=function(t,e){var s=$(e),i=this.rootDom.querySelector(this.dragItemClass);if($(i).hasClass("wtc_stepConfig_item"))s.hasClass("wtc_stepConfig_span-top-bottom")||"step"===s[0].className.baseVal.split(" ")[2].split("-")[1]||"wtc_stepConfig_item0"===s[0].className.baseVal.split(" ")[1].split("-")[1]||this.showHotPart(e,"parse_line",t);else{var n=i.parentNode.parentNode.parentNode;if(s.hasClass("wtc_stepConfig_span-top-bottom"))s[0].parentNode.parentNode.parentNode.parentNode===n&&this.showHotPart(e,"step_span",t);else if("step"===s[0].className.baseVal.split(" ")[2].split("-")[1]){var a=s[0].className.baseVal.split(" ")[2].slice(4);$("."+a,n)[0]&&this.showHotPart(e,"step_line",t)}}},t.prototype.showHotPart=function(t,e,s){s.preventDefault(),"step_span"===e?(t.style.border="1px dashed #FF5F1F",t.style.backgroundColor="rgba(255, 95, 31, 0.08)"):$(".wtc_stepConfig_svg-rect",t).css("display","block")},t.prototype.hideHotPart=function(){$(".wtc_stepConfig_svg-rect",this.rootDom).css("display","none"),$(".wtc_stepConfig_span-top-bottom",this.rootDom).css({border:"none",backgroundColor:"initial"})},t.prototype.drag=function(t,e){var s=e.target.parentNode.parentNode;if(this.getDataPosition(s).data.move){var i=void 0;i=$(s).hasClass("step-item")?s.parentNode.parentNode.parentNode.parentNode.className.split(" ")[1]:s.parentNode.className.split(" ")[1];var n=s.className.split(" ")[1];e.dataTransfer.setData("className","."+i+" ."+n),this.dragItemClass="."+i+" ."+n}else e.preventDefault()},t.prototype.drop=function(t,e){t.preventDefault();var s=$(e),i=t.dataTransfer.getData("className"),n=this.rootDom.querySelector(i),a=n.parentElement;this.moveItem(s,n)&&(this.delEmptyRow(a),this.refreshLine(),this.refreshLineEvent())},t.prototype.moveItem=function(t,e){var s=$(e);if(s.hasClass("wtc_stepConfig_item")){var i=t[0].className.baseVal.split(" ")[1].slice(4),n=t[0].className.baseVal.split(" ")[2].slice(4);if(s.hasClass(i)||s.hasClass(n))return!1;var a=$("."+i,this.rootDom).parent();return this.movePhase(a,e,!1)}if(t.hasClass("wtc_stepConfig_span-top-bottom")){var o=$(".wtc_stepConfig_span-top-bottom",e);return o[0]===t[0]||o[1]===t[0]||this.moveStep_span(t.parent(),e,t.hasClass("wtc_stepConfig_span-top")),!1}var p=t[0].className.baseVal.split(" ")[1].slice(4),l=t[0].className.baseVal.split(" ")[2].slice(4);if(s.hasClass(p)||s.hasClass(l))return!1;var r=e.parentElement.parentElement.parentElement.parentElement;return this.moveStep($("."+p,r),e),!1},t.prototype.movePhase=function(t,e,s){var i=t[0].className.split(" ")[1],n=Number(i.split("_")[1]),a=n+1,o=e.parentElement.className.split(" ")[1],p=Number(o.split("_")[1]),l=JSON.parse(JSON.stringify(this.data.data));if(p>=n){var r=l.splice(p-1,1);l.splice(n,0,r[0])}else{var d=l.splice(p-1,1);l.splice(n-1,0,d[0])}if(this.moveLegal("phase",l)){s||(p>=n?this.stack.push({type:"movePhase",phasePosition:n,oldPhasePosition:p-1}):this.stack.push({type:"movePhase",phasePosition:n-1,oldPhasePosition:p-1})),this.data.data=l;for(var c=t[0].nextElementSibling;$(c).hasClass("row");)c.className="row row_"+(n+2),n++,c=c.nextElementSibling;if("block"===$(".wtc_stepConfig_item-step",e).css("display")){var m=e.querySelector(".wtc_stepConfig_item-main-text");this.toggleSteps(m)}return t.after('<div class="row row_'+a+'"></div>'),$(".row_"+a,this.rootDom).append(e),this.model.invoke("positionChange"),!0}return this.myTool.message({type:"warn",message:this.langText_message1}),!1},t.prototype.moveStep=function(t,e){for(var s=t.parent(),i=s[0].className.split(" ")[1].split("-")[2],n=s.parent().parent().parent()[0].className.split(" ")[1],a=Number(n.split("_")[1]),o=e.parentElement.className.split(" ")[1].split("-")[2],p=void 0,l=void 0,r=0;r<this.data.data[a-1].steps.length;r++){var d=this.data.data[a-1].steps[r];d.id==i&&(l=r),d.id==o&&(p=r)}var c=JSON.parse(JSON.stringify(this.data.data));if(p>=l){var m=c[a-1].steps.splice(p,1);c[a-1].steps.splice(l+1,0,m[0])}else{var h=c[a-1].steps.splice(p,1);c[a-1].steps.splice(l,0,h[0])}return this.moveLegal("step",c,a-1)?(p>=l?this.stack.push({type:"moveStep",phasePosition:a-1,stepPosition:l+1,oldStepPosition:p}):this.stack.push({type:"moveStep",phasePosition:a-1,stepPosition:l,oldStepPosition:p}),this.data.data=c,s.after(e.parentElement),this.refreshLine(),this.refreshLineEvent(),this.model.invoke("positionChange")):this.myTool.message({type:"warn",message:this.langText_message1}),!1},t.prototype.moveStep_span=function(t,e,s){for(var i=t.parent(),n=i[0].className.split(" ")[1].split("-")[2],a=e.parentElement.className.split(" ")[1].split("-")[2],o=i.parent().parent().parent()[0].className.split(" ")[1],p=Number(o.split("_")[1]),l=void 0,r=void 0,d=0;d<this.data.data[p-1].steps.length;d++){var c=this.data.data[p-1].steps[d];c.id==n&&(r=d),c.id==a&&(l=d)}var m=JSON.parse(JSON.stringify(this.data.data)),h=m[p-1].steps.splice(l,1);return m[p-1].steps.splice(r,0,h[0]),this.moveLegal("step",m,p-1)?(this.stack.push({type:"moveStep",phasePosition:p-1,stepPosition:r,oldStepPosition:l}),this.data.data=m,s?i.before(e.parentElement):i.after(e.parentElement),this.refreshLine(),this.refreshLineEvent(),this.model.invoke("positionChange")):this.myTool.message({type:"warn",message:this.langText_message1}),!1},t.prototype.delEmptyRow=function(t){var e=t.className.split(" ")[1];if(e=Number(e.split("_")[1]),""===t.innerHTML.trim()){t.parentNode.removeChild(t);for(var s=this.rootDom.querySelector(".row_"+(e+1));s;)s.className="row row_"+e,e++,s=this.rootDom.querySelector(".row_"+(e+1));return!0}return!1},t.prototype.refreshLine=function(){var t=this.dom_container.querySelectorAll(".wtc_stepConfig_item"),e=this.dom_container.querySelectorAll(".step-item"),s=[].concat(_toConsumableArray(t),_toConsumableArray(e));this.itemDisconnect();var i=this.itemConnect(s);$(this.dom_container).append(i)},t.prototype.itemDisconnect=function(t){if(t)for(var e=0;e<t.length;e++){var s=t[e].className.split(" ")[1];$(".svg-"+s,this.dom_container).remove()}else $(".wtc_stepConfig_svg-wrap",this.dom_container).remove()},t.prototype.itemConnect=function(t){for(var e="",s=[],i=0;i<t.length;i++){var n=t[i],a=$(n).hasClass("wtc_stepConfig_item")?0:1,o=$(".item-main",n),p=$(".item-main-bottom-dot",o),l=this.getPosition(p[0],this.dom_container);1===a&&(l.left-=100);var r=n.parentElement.nextElementSibling;if($(r).hasClass("row")||$(r).hasClass("step-row")){var d=r.firstElementChild,c=$(".item-main",d),m=$(".item-main-top-dot",c),h=this.getPosition(m[0],this.dom_container);1===a&&(h.left-=100);var g=n.className.split(" ")[1],_=d.className.split(" ")[1],f=Math.abs(h.left-l.left)+60,v=h.top-l.top,w=l.top,u=h.left>l.left?l.left-30:h.left-30;if(h.left>l.left)e+='\n            <svg class="wtc_stepConfig_svg-wrap svg-'+g+" svg-"+_+'" version="1.1" xmlns="http://www.w3.org/2000/svg" style="top:'+w+"px;left:"+u+"px;width:"+f+"px;height:"+v+"px; z-index:"+(1===a?1010:0)+'">\n                <g class="wtc_stepConfig_svg-group" stroke-width="1">\n                    <rect class="wtc_stepConfig_svg-rect" rx="2" ry="2" x="0" y="'+(v/2-16)+'" width="60" height="32" style="display:none;fill:rgba(255, 95, 31, 0.08);stroke-width:1;stroke:#FF5F1F;stroke-dasharray:2,2;"/>\n                    <polyline points="30,0 30,'+v/2+" "+(f-30)+","+v/2+" "+(f-30)+","+v+'" style="fill:#212121;stroke: #fff; stroke-width: 60;opacity:0"/>\n                    <polyline points="30,0 30,'+v/2+" "+(f-30)+","+v/2+" "+(f-30)+","+v+'" style="fill:white;"/>\n                    <polyline points="'+(f-30-4)+","+(v-5)+" "+(f-30)+","+v+" "+(f-30+4)+","+(v-5)+'" style="fill:#212121;"/>',0==this.data.type&&0===a&&"wtc_stepConfig_item0"!==g&&(e+='<use class="add-btn" x="30" y="'+v/2+'"  xlink:href="#wtc_stepConfig_g1"></use>'),e+="</g></svg>";else{var C="";C+='\n            <svg class="wtc_stepConfig_svg-wrap svg-'+g+" svg-"+_+'" version="1.1" xmlns="http://www.w3.org/2000/svg" style="top:'+w+"px;left:"+u+"px;width:"+f+"px;height:"+v+"px; z-index:"+(1===a?1010:0)+'">\n                <g class="wtc_stepConfig_svg-group" stroke-width="1">\n                    <rect class="wtc_stepConfig_svg-rect" rx="2" ry="2" x="0" y="'+(v/2-16)+'" width="60" height="32" style="display:none;fill:rgba(255, 95, 31, 0.08);stroke-width:1;stroke:#FF5F1F;stroke-dasharray:2,2;"/>\n                    <polyline points="'+(f-30)+",0 "+(f-30)+","+v/2+" 30,"+v/2+" 30,"+v+'" style="fill:#212121;stroke: #fff; stroke-width: 60;opacity:0"/>\n                    <polyline points="'+(f-30)+",0 "+(f-30)+","+v/2+" 30,"+v/2+" 30,"+v+'" style="fill:white;"/>\n                    <polyline points="26,'+(v-5)+" 30,"+v+" 34,"+(v-5)+'" style="fill:#212121;"/>',0==this.data.type&&0===a&&"wtc_stepConfig_item0"!==g&&(C+='<use class="add-btn" x="'+(f-30)+'" y="'+v/2+'"  xlink:href="#wtc_stepConfig_g1"></use>'),C+="</g></svg>",s.push(C)}}}for(var x=s.length-1;x>=0;x--)e+=s[x];return e},t.prototype.refreshLineEvent=function(){var t=this;0==this.data.type&&($(".wtc_stepConfig_svg-group",this.rootDom).off("mouseenter"),$(".wtc_stepConfig_svg-group",this.rootDom).off("mouseleave"),$(".wtc_stepConfig_svg-wrap",this.rootDom).off("dragover"),$(".wtc_stepConfig_svg-wrap",this.rootDom).off("dragleave"),$(".wtc_stepConfig_svg-wrap",this.rootDom).off("drop"),$(".wtc_stepConfig_svg-group",t.rootDom).on({mouseenter:function(){t.showAddBtn(this)},mouseleave:function(){t.hideAddBtn(this)}}),$(".wtc_stepConfig_svg-wrap",t.rootDom).on({dragover:function(e){t.allowDrop(e.originalEvent,this)},dragleave:function(e){t.hideHotPart()},drop:function(e){t.drop(e.originalEvent,this)}}))},t.prototype.clickHandle=function(t){var e=this;if("string"==typeof t.className)switch(t.className){case"wtc_stepConfig_icon-step-num":e.toggleSteps(t);break;case"wtc_stepConfig_item-input wtc_stepConfig_item-main-text":case"wtc_stepConfig_item-input wtc_stepConfig_item-main-text item-main-active":if($(t).hasClass("item-main-active"))return;clearTimeout(e.timer),e.timer=setTimeout((function(){$(".wtc_stepConfig_item-input",e.dom_container).removeClass("item-main-active"),$(t).addClass("item-main-active"),e.data.power&&e.showSeniorSet(t.parentElement.parentElement)}),240);break;case"wtc_stepConfig_item-input wtc_stepConfig_item-step-text":case"wtc_stepConfig_item-input wtc_stepConfig_item-step-text item-main-active":if($(t).hasClass("item-main-active"))return;$(".wtc_stepConfig_item-input",this.dom_container).removeClass("item-main-active"),$(t).addClass("item-main-active"),this.data.power&&this.showSeniorSet(t.parentElement.parentElement);break;case"wtc_stepConfig_icon-set kdfont kdfont-shezhi11":case"wtc_stepConfig_icon-set kdfont kdfont-yanjing":$(".wtc_stepConfig_item-input",e.dom_container).removeClass("item-main-active"),$(".wtc_stepConfig_item-input",t.parentElement.parentElement).addClass("item-main-active"),e.setEvent(t),this.data.power&&this.showSeniorSet(t.parentElement.parentElement.parentElement);break;case"wtc_stepConfig_icon-del kdfont kdfont-shanchu7":$(".wtc_stepConfig_item-input",e.dom_container).removeClass("item-main-active"),$(".wtc_stepConfig_item-input",t.parentElement.parentElement).addClass("item-main-active"),e.delEvent(t),this.data.power&&this.showSeniorSet(t.parentElement.parentElement.parentElement)}else"add-btn"===t.className.baseVal&&e.addPhaseClick(t)},t.prototype.showSeniorSet=function(t){$(".wtc_stepConfig_senior-dialog").css("display","block");var e=this.getDataPosition(t);this.modifySeniorSetData(e.type,e.data.phaseResultDeal,e.data.noReturnHandler,e.data.edit);var s=this.getPosition(t,null).top-50,i=document.documentElement.clientHeight||document.body.clientHeight;"phase"===e.type&&s+470>i&&(s=i-470),"step"===e.type&&s+350>i&&(s=i-350),$(".wtc_stepConfig_senior-dialog",this.rootDom).css("top",s+"px")},t.prototype.modifySeniorSetData=function(t,e,s,i){var n=$(".wtc_stepConfig_senior-dialog-set1",this.rootDom),a=$(".wtc_stepConfig_senior-dialog-set3",this.rootDom);if("phase"===t){n.css("display","block"),i?n.removeClass("wtc_stepConfig_senior-phaseResultDeal-disabled"):n.addClass("wtc_stepConfig_senior-phaseResultDeal-disabled");var o=$(".item-main-active",this.rootDom).val();$(".wtc_stepConfig_senior-dialog-phase-name",this.rootDom).html(this.langText_phase+o),$(".wtc_stepConfig_senior-dialog-options-item",n).removeClass("wtc_stepConfig_senior-dialog-options-item-active");var p=$(".wtc_stepConfig_senior-dialog-options-item[index="+e+"]",n);p.addClass("wtc_stepConfig_senior-dialog-options-item-active"),$(".wtc_stepConfig_senior-dialog-selected",n).html(p.html())}else{n.css("display","none");var l=$(".item-main-active",this.rootDom).val();$(".wtc_stepConfig_senior-dialog-phase-name",this.rootDom).html(this.langText_step+l)}$(".wtc_stepConfig_senior-dialog-options-item",a).removeClass("wtc_stepConfig_senior-dialog-options-item-active");var r=$(".wtc_stepConfig_senior-dialog-options-item[index="+s+"]",a);r.addClass("wtc_stepConfig_senior-dialog-options-item-active"),$(".wtc_stepConfig_senior-dialog-selected",a).html(r.html())},t.prototype.addPhaseClick=function(t){for(var e=t.parentElement.parentElement.className.baseVal.split(" ")[1].split("-")[1],s=this.dom_container.querySelector("."+e).parentElement.className.split(" ")[1],i=Number(s.split("_")[1]),n=[],a=[],o=0;o<this.data.data.length;o++){a.push({phaseId:this.data.data[o].phaseId,phase:this.data.data[o].phase,phaseNameLang:this.data.data[o].phaseNameLang});for(var p=0;p<this.data.data[o].steps.length;p++)n.push(this.data.data[o].steps[p].id)}this.model.invoke("addphase",{position:i,othersteps:n,otherPhaseList:a})},t.prototype.addPhase=function(t,e){var s=JSON.parse(JSON.stringify(this.data.data));s.splice(t,0,e[0]),this.moveLegal("phase",s)?(this.stack.push({type:"add",phasePosition:t}),this.data.data=s,this.addPhase_inner(t,e)):this.myTool.message({type:"warn",message:"“"+e[0].phase+"”"+this.langText_message2})},t.prototype.addPhase_inner=function(t,e){var s=this,i=this.dom_container.querySelector(".row_"+t),n=t+1;s.itemIndex++;for(var a=this.rootDom.querySelector(".row_"+n);$(a).hasClass("row");)a.className="row row_"+(n+1),n++,a=a.nextElementSibling;for(var o='\n                <div class="row row_'+(t+1)+'">\n                    <div class="wtc_stepConfig_item wtc_stepConfig_item'+this.itemIndex+'">\n                        <div class="item-span-left"></div>\n                        <div class="item-main">\n                            <div class="item-main-top-dot"></div>\n                            <div class="item-main-bottom-dot"></div>\n                            <input class="wtc_stepConfig_item-input wtc_stepConfig_item-main-text" title="'+e[0].phase+'" value="'+e[0].phase+'" readonly="true" draggable="true">\n                            <i class="wtc_stepConfig_icon-step-num" stepnum="'+e[0].steps.length+'">'+e[0].steps.length+'</i>\n                            <div class="wtc_stepConfig_icon-wrap">\n                                <i class="wtc_stepConfig_icon-set kdfont kdfont-shezhi11"></i>\n                                '+(e[0].del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                            </div>\n                        </div>\n                        <div class="item-span-right"></div>\n                        <div class="wtc_stepConfig_item-step">\n                            <div class="wtc_stepConfig_item-step-triangle"></div>\n                            <div class="wtc_stepConfig_item-step-triangle2"></div>\n         ',p=0;p<e[0].steps.length;p++){var l=e[0].steps[p],r=l.syspreset?"kdfont-yanjing":"kdfont-shezhi11";l.desc=l.desc||this.langText_none;var d=l.desc.slice(0,48),c=l.desc.slice(48);o+='\n                    <div class="step-row step-row-'+l.id+'">\n                        <div class="step-item step-item-'+l.id+'">\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-top" style="position:absolute;top:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-bottom" style="position:absolute;bottom:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                            <div class="item-span-left"></div>\n                            <div class="item-main item-main-step">\n                                <div class="item-main-top-dot"></div>\n                                <div class="item-main-bottom-dot"></div>\n                                <input class="wtc_stepConfig_item-input wtc_stepConfig_item-step-text" value="'+l.step+'" readonly="true" draggable="true">\n                                <div class="wtc_stepConfig_step-detail">\n                                    <div class="wtc_stepConfig_step-detail-item">'+l.step+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_effectiveDate+"："+l.startdate+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_resultType+"："+("1"==l.resulttype?this.langText_timePair:this.langText_itemValue)+'</div>\n                                    \x3c!--<div class="wtc_stepConfig_step-detail-item">'+this.langText_calrule+"："+("1"==l.calrule?this.langText_customFormula:this.langText_customCode)+'</div>--\x3e\n                                    <div class="wtc_stepConfig_step-detail-item">\n                                        <span class="wtc_stepConfig_step-detail-item-first-text">'+this.langText_desc+"："+d+'</span>\n                                        <span class="wtc_stepConfig_step-detail-item-other-text">'+c+"</span>\n                                        "+(c?'<span class="wtc_stepConfig_step-detail-item-open">'+this.langText_open+"</span>":"")+'\n                                    </div>\n                                </div>\n                                <div class="wtc_stepConfig_icon-wrap">\n                                    <i class="wtc_stepConfig_icon-set kdfont '+r+'"></i>\n                                    '+(l.del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                                </div>\n                            </div>\n                            <div class="item-span-right"></div>\n                        </div>\n                    </div>\n                '}o+="</div></div></div>",$(i).after(o);var m=$(".row_"+(t+1),this.rootDom);this.refreshLine(),this.refreshLineEvent(),$(".wtc_stepConfig_span-top-bottom",s.rootDom).on({dragover:function(t){s.allowDrop(t.originalEvent,this)},dragleave:function(t){s.hideHotPart()},drop:function(t){s.drop(t.originalEvent,this)}}),$(".wtc_stepConfig_item",m).on({dragstart:function(t){s.drag("phase",t.originalEvent)},dragend:function(){s.hideHotPart()}}),$(".step-item",m).on({dragstart:function(t){t.stopPropagation(),s.drag("step",t.originalEvent)},dragend:function(){s.hideHotPart()}}),$(".item-main",m).on({"mouseenter.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","block")},"mouseleave.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","none")}});var h=$(".wtc_stepConfig_item-main-text",m);h.on("blur",(function(){s.modifyName_confirm(this)})),s.clickHandle(h[0]),$(".item-main-step",m).hover((function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=4}),(function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=3})),$(".wtc_stepConfig_step-detail-item-open",m).click((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","inline"),$(this).css("display","none")})),$(".item-main",m).mouseleave((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).html()&&($(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","none"),$(".wtc_stepConfig_step-detail-item-open",this.parentElement).css("display","inline"))}))},t.prototype.addStep=function(t,e,s){var i=this,n=$(".row_"+(t+1),this.dom_container),a=$(".step-row",n)[e-1<0?0:e-1],o=s.syspreset?"kdfont-yanjing":"kdfont-shezhi11";s.desc=s.desc||this.langText_none;var p=s.desc.slice(0,48),l=s.desc.slice(48),r='\n                    <div class="step-row step-row-'+s.id+'">\n                        <div class="step-item step-item-'+s.id+'">\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-top" style="position:absolute;top:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                            <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-bottom" style="position:absolute;bottom:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                            <div class="item-span-left"></div>\n                            <div class="item-main item-main-step">\n                                <div class="item-main-top-dot"></div>\n                                <div class="item-main-bottom-dot"></div>\n                                <input class="wtc_stepConfig_item-input wtc_stepConfig_item-step-text" value="'+s.step+'" readonly="true" draggable="true">\n                                <div class="wtc_stepConfig_step-detail">\n                                    <div class="wtc_stepConfig_step-detail-item">'+s.step+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_effectiveDate+"："+s.startdate+'</div>\n                                    <div class="wtc_stepConfig_step-detail-item">'+this.langText_resultType+"："+("1"==s.resulttype?this.langText_timePair:this.langText_itemValue)+'</div>\n                                    \x3c!--<div class="wtc_stepConfig_step-detail-item">'+this.langText_calrule+"："+("1"==s.calrule?this.langText_customFormula:this.langText_customCode)+'</div>--\x3e\n                                    <div class="wtc_stepConfig_step-detail-item">\n                                        <span class="wtc_stepConfig_step-detail-item-first-text">'+this.langText_desc+"："+p+'</span>\n                                        <span class="wtc_stepConfig_step-detail-item-other-text">'+l+"</span>\n                                        "+(l?'<span class="wtc_stepConfig_step-detail-item-open">'+this.langText_open+"</span>":"")+'\n                                    </div>\n                                </div>\n                                <div class="wtc_stepConfig_icon-wrap">\n                                    <i class="wtc_stepConfig_icon-set kdfont '+o+'"></i>\n                                    '+(s.del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                                </div>\n                            </div>\n                            <div class="item-span-right"></div>\n                        </div>\n                    </div>\n                ';e-1<0?$(a).before(r):$(a).after(r);var d=$(".step-row-"+s.id,n);n.css("padding-bottom",parseInt(n.css("padding-bottom"))+52+"px"),this.refreshLine(),this.refreshLineEvent(),$(".wtc_stepConfig_span-top-bottom",d).on({dragover:function(t){i.allowDrop(t.originalEvent,this)},dragleave:function(t){i.hideHotPart()},drop:function(t){i.drop(t.originalEvent,this)}}),$(".step-item",d).on({dragstart:function(t){t.stopPropagation(),i.drag("step",t.originalEvent)},dragend:function(){i.hideHotPart()}}),$(".item-main",d).on({"mouseenter.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","block")},"mouseleave.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","none")}}),$(".item-main-step",d).hover((function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=4}),(function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=3})),$(".wtc_stepConfig_step-detail-item-open",d).click((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","inline"),$(this).css("display","none")}))},t.prototype.toggleSteps=function(t){"block"===$(".wtc_stepConfig_item-step",t.parentElement.parentElement).css("display")?this.foldSteps(t):this.openSteps(t)},t.prototype.openSteps=function(t){var e=$(t),s=t.parentElement.parentElement,i=$(s.parentElement),n=$(".wtc_stepConfig_item-step",t.parentElement.parentElement);e.hasClass("wtc_stepConfig_item-main-text")?t.nextElementSibling.innerHTML="-":t.innerHTML="-",n.show(),i.css("padding-bottom",parseInt(i.css("padding-bottom"))+n.height()-20+"px"),this.refreshLine(),this.refreshLineEvent()},t.prototype.foldSteps=function(t){var e=$(t),s=t.parentElement.parentElement,i=$(s.parentElement),n=$(".wtc_stepConfig_item-step",t.parentElement.parentElement);e.hasClass("wtc_stepConfig_item-main-text")?t.nextElementSibling.innerHTML=t.nextElementSibling.getAttribute("stepnum"):t.innerHTML=t.getAttribute("stepnum"),i.css("padding-bottom",parseInt(i.css("padding-bottom"))-n.height()+20+"px"),n.hide(),this.refreshLine(),this.refreshLineEvent()},t.prototype.setEvent=function(t){var e=$(t.parentElement.parentElement.parentElement);if(e.hasClass("step-item")){var s=e[0].className.split(" ")[1].split("-")[2];this.model.invoke("editsteps",{stepid:s})}else{for(var i=e[0].parentElement.className.split(" ")[1],n=Number(i.split("_")[1]),a=[],o=0;o<this.data.data[n-1].steps.length;o++)a.push({id:this.data.data[n-1].steps[o].id,noReturnHandler:this.data.data[n-1].steps[o].noReturnHandler,move:this.data.data[n-1].steps[o].move,del:this.data.data[n-1].steps[o].del});for(var p=[],l=[],r=0;r<this.data.data.length;r++)if(r!==n-1){l.push({phaseId:this.data.data[r].phaseId,phase:this.data.data[r].phase,phaseNameLang:this.data.data[r].phaseNameLang});for(var d=0;d<this.data.data[r].steps.length;d++)p.push(this.data.data[r].steps[d].id)}this.model.invoke("editphase",{phase:this.data.data[n-1].phase,phaseNameLang:this.data.data[n-1].phaseNameLang,phaseId:this.data.data[n-1].phaseId,move:this.data.data[n-1].move,del:this.data.data[n-1].del,noReturnHandler:this.data.data[n-1].noReturnHandler,phaseResultDeal:this.data.data[n-1].phaseResultDeal,phaseSave:this.data.data[n-1].phaseSave,phasenumber:this.data.data[n-1].phasenumber,position:n,steps:a,othersteps:p,otherPhaseList:l})}},t.prototype.modifyPhase=function(t,e){var s=JSON.parse(JSON.stringify(this.data.data));s.splice(t-1,1,e[0]),this.moveLegal("step",s,t-1)?(this.stack.push({type:"modify",phasePosition:t-1,data:this.data.data[t-1]}),this.data.data=s,this.modifyPhase_inner(t,e)):this.myTool.message({type:"warn",message:"“"+e[0].phase+"”"+this.langText_message2})},t.prototype.modifyPhase_inner=function(t,e){var s=this,i=$(".row_"+t,this.rootDom),n=$(".wtc_stepConfig_item",i),a="block"===$(".wtc_stepConfig_item-step",i).css("display"),o=$(".wtc_stepConfig_item-main-text",i),p=o.hasClass("item-main-active");a&&this.toggleSteps(o[0]),this.itemIndex++;for(var l='\n            <div class="wtc_stepConfig_item wtc_stepConfig_item'+this.itemIndex+'">\n                <div class="item-span-left"></div>\n                <div class="item-main">\n                    <div class="item-main-top-dot"></div>\n                    <div class="item-main-bottom-dot"></div>\n                    <input class="wtc_stepConfig_item-input wtc_stepConfig_item-main-text'+(p?" item-main-active":"")+'" title="'+e[0].phase+'" value="'+e[0].phase+'" readonly="true" draggable="true">\n                    <i class="wtc_stepConfig_icon-step-num" stepnum="'+e[0].steps.length+'">'+e[0].steps.length+'</i>\n                    <div class="wtc_stepConfig_icon-wrap">\n                        <i class="wtc_stepConfig_icon-set kdfont kdfont-shezhi11"></i>\n                        '+(e[0].del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                    </div>\n                </div>\n                <div class="item-span-right"></div>\n                <div class="wtc_stepConfig_item-step">\n                    <div class="wtc_stepConfig_item-step-triangle"></div>\n                    <div class="wtc_stepConfig_item-step-triangle2"></div>\n        ',r=0;r<e[0].steps.length;r++){var d=e[0].steps[r],c=d.syspreset?"kdfont-yanjing":"kdfont-shezhi11";d.desc=d.desc||this.langText_none;var m=d.desc.slice(0,48),h=d.desc.slice(48);l+='\n                <div class="step-row step-row-'+d.id+'">\n                    <div class="step-item step-item-'+d.id+'">\n                        <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-top" style="position:absolute;top:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                        <div class="wtc_stepConfig_span-top-bottom wtc_stepConfig_span-bottom" style="position:absolute;bottom:-20px;left:50%;transform: translateX(-50%);width: 60px;height: 20px;"></div>\n                        <div class="item-span-left"></div>\n                        <div class="item-main item-main-step">\n                            <div class="item-main-top-dot"></div>\n                            <div class="item-main-bottom-dot"></div>\n                            <input class="wtc_stepConfig_item-input wtc_stepConfig_item-step-text" value="'+d.step+'" readonly="true" draggable="true">\n                            <div class="wtc_stepConfig_step-detail">\n                                <div class="wtc_stepConfig_step-detail-item">'+d.step+'</div>\n                                <div class="wtc_stepConfig_step-detail-item">'+this.langText_effectiveDate+"："+d.startdate+'</div>\n                                <div class="wtc_stepConfig_step-detail-item">'+this.langText_resultType+"："+("1"==d.resulttype?this.langText_timePair:this.langText_itemValue)+'</div>\n                                \x3c!--<div class="wtc_stepConfig_step-detail-item">'+this.langText_calrule+"："+("1"==d.calrule?this.langText_customFormula:this.langText_customCode)+'</div>--\x3e\n                                <div class="wtc_stepConfig_step-detail-item">\n                                    <span class="wtc_stepConfig_step-detail-item-first-text">'+this.langText_desc+"："+m+'</span>\n                                    <span class="wtc_stepConfig_step-detail-item-other-text">'+h+"</span>\n                                    "+(h?'<span class="wtc_stepConfig_step-detail-item-open">'+this.langText_open+"</span>":"")+'\n                                </div>\n                            </div>\n                            <div class="wtc_stepConfig_icon-wrap">\n                                <i class="wtc_stepConfig_icon-set kdfont '+c+'"></i>\n                                '+(d.del?'<i class="wtc_stepConfig_icon-del kdfont kdfont-shanchu7"></i>':"")+'\n                            </div>\n                        </div>\n                        <div class="item-span-right"></div>\n                    </div>\n                </div>\n            '}l+="</div></div>",n.replaceWith(l),a&&(o=$(".wtc_stepConfig_item-main-text",i),this.toggleSteps(o[0])),s.refreshLine(),s.refreshLineEvent(),$(".wtc_stepConfig_span-top-bottom",i).on({dragover:function(t){s.allowDrop(t.originalEvent,this)},dragleave:function(t){s.hideHotPart()},drop:function(t){s.drop(t.originalEvent,this)}}),$(".wtc_stepConfig_item",i).on({dragstart:function(t){s.drag("phase",t.originalEvent)},dragend:function(){s.hideHotPart()}}),$(".step-item",i).on({dragstart:function(t){t.stopPropagation(),s.drag("step",t.originalEvent)},dragend:function(){s.hideHotPart()}}),$(".item-main",i).on({"mouseenter.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","block")},"mouseleave.showIcon":function(){$(".wtc_stepConfig_icon-wrap",this).css("display","none")}}),$(".wtc_stepConfig_item-main-text",i).on("blur",(function(){s.modifyName_confirm(this)})),$(".item-main-step",i).hover((function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=4}),(function(t){this.parentElement.parentElement.parentElement.parentElement.style.zIndex=3})),$(".wtc_stepConfig_step-detail-item-open",i).click((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","inline"),$(this).css("display","none")})),$(".item-main",i).mouseleave((function(){$(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).html()&&($(".wtc_stepConfig_step-detail-item-other-text",this.parentElement).css("display","none"),$(".wtc_stepConfig_step-detail-item-open",this.parentElement).css("display","inline"))}))},t.prototype.delEvent=function(t){var e=this,s=$(t.parentElement.parentElement.parentElement);if(s.hasClass("step-item")){var i=$(".wtc_stepConfig_item-step-text",s).val();this.myTool.confirmDialog({text:this.langText_deleteConfirm+i+this.langText_warn1,showTitle:!0,showImg:!0,showBtn:!0,title:this.langText_operationConfirm,img:e.KDApi.getNameSpace(e.model)+"images/delete.png",confirmBtn:this.langText_confirm,cancelBtn:this.langText_cancel,confirmCallback:function(){if($(".step-row",s.parent().parent()).length>1){var t=e.getDataPosition(s[0]);e.stack.push({type:"delStep",phasePosition:t.phaseIndex,stepPosition:t.stepIndex,data:t.data}),e.data.data[t.phaseIndex].steps.splice(t.stepIndex,1);var i=s[0].parentElement.parentElement.parentElement.parentElement;s.parent().remove();var n=$(".wtc_stepConfig_item-step",i).height();$(i).css("padding-bottom",50+n-20+"px");var a=$(".wtc_stepConfig_icon-step-num",i);a.attr("stepnum",Number(a.attr("stepnum"))-1),e.refreshLine(),e.refreshLineEvent(),$(".wtc_stepConfig_senior-dialog",e.rootDom).hide()}else e.myTool.message({type:"warn",message:e.langText_message3})},cancelCallback:function(){}})}else{var n=$(".wtc_stepConfig_item-main-text",s).val();this.myTool.confirmDialog({text:this.langText_deleteConfirm+n+this.langText_warn1,showTitle:!0,showImg:!0,showBtn:!0,title:this.langText_operationConfirm,img:e.KDApi.getNameSpace(e.model)+"images/delete.png",confirmBtn:this.langText_confirm,cancelBtn:this.langText_cancel,confirmCallback:function(){var t=s[0].parentElement,i=t.className.split(" ")[1],n=Number(i.split("_")[1]);e.stack.push({type:"delPhase",phasePosition:n-1,data:e.data.data[n-1]}),e.data.data.splice(n-1,1),s.remove(),e.delEmptyRow(t),e.refreshLine(),e.refreshLineEvent(),$(".wtc_stepConfig_senior-dialog",e.rootDom).hide()},cancelCallback:function(){}})}},t.prototype.modifyName=function(t){var e=$(t);e.addClass("wtc_stepConfig_parse-input-edit"),e.attr("readonly",!1).focus();var s=e.val();e.val(""),e.val(s)},t.prototype.modifyName_confirm=function(t){if(!t.readOnly){var e=$(t);e.removeClass("wtc_stepConfig_parse-input-edit"),e.attr("readonly",!0);var s=e.val(),i=t.parentElement.parentElement.parentElement.className.split(" ")[1],n=Number(i.split("_")[1]);if(this.data.data[n-1].phase!==s){if(""===s.trim())return this.myTool.message({type:"warn",message:this.langText_message5}),void e.val(this.data.data[n-1].phase);for(var a=0;a<this.data.data.length;a++)if(this.data.data[a].phase===s)return this.myTool.message({type:"warn",message:this.langText_message6}),void e.val(this.data.data[n-1].phase);this.stack.push({type:"modifyName",phasePosition:n-1,data:this.data.data[n-1].phase}),this.data.data[n-1].phase=s,e.attr("title",s)}}},t.prototype.backHandle=function(){var t=this.stack.pop();if(t)switch(t.type){case"add":this.data.data.splice(t.phasePosition,1);var e=$(".row_"+(t.phasePosition+1),this.dom_container)[0];$(e.firstElementChild).remove(),this.delEmptyRow(e),this.refreshLine(),this.refreshLineEvent();break;case"modify":this.data.data.splice(t.phasePosition,1,t.data),this.modifyPhase_inner(t.phasePosition+1,[t.data]);break;case"delPhase":this.data.data.splice(t.phasePosition,0,t.data),this.addPhase_inner(t.phasePosition,[t.data]);break;case"delStep":this.data.data[t.phasePosition].steps.splice(t.stepPosition,0,t.data),this.addStep(t.phasePosition,t.stepPosition,t.data);break;case"movePhase":var s=$(".row_"+(t.phasePosition+1),this.dom_container)[0],i=$(s.firstElementChild)[0];if(t.phasePosition<t.oldPhasePosition)var n=$(".row_"+(t.oldPhasePosition+1),this.dom_container);else n=$(".row_"+t.oldPhasePosition,this.dom_container);this.movePhase(n,i,!0),this.delEmptyRow(s),this.refreshLine(),this.refreshLineEvent();break;case"moveStep":s=$(".row_"+(t.phasePosition+1),this.dom_container)[0];var a=$(".step-item",s)[t.stepPosition],o=$($(".step-row",s)[t.oldStepPosition]),p=this.data.data[t.phasePosition].steps.splice(t.stepPosition,1);this.data.data[t.phasePosition].steps.splice(t.oldStepPosition,0,p[0]),t.oldStepPosition>=t.stepPosition?o.after(a.parentElement):o.before(a.parentElement),this.refreshLine(),this.refreshLineEvent();break;case"modifyName":this.data.data[t.phasePosition].phase=t.data;s=$(".row_"+(t.phasePosition+1),this.dom_container)[0];var l=$(".wtc_stepConfig_item-main-text",s);l.val(t.data),l.attr("title",t.data)}},t.prototype.showAddBtn=function(t){$(".add-btn",t).css("display","block")},t.prototype.hideAddBtn=function(t){$(".add-btn",t).css("display","none")},t.prototype.getPosition=function(t,e){for(var s=t.offsetLeft-t.scrollLeft,i=t.offsetTop-t.scrollTop,n=t.offsetParent;n&&n!==e;)s+=n.offsetLeft-n.scrollLeft,i+=n.offsetTop-n.scrollTop,n=n.offsetParent;return{left:s,top:i}},t.prototype.moveLegal=function(t,e,s){var i=Number.MIN_SAFE_INTEGER;if("phase"===t){for(var n=0;n<e.length;n++)for(var a=0;a<e[n].steps.length;a++)if(e[n].steps[a].syspreset){var o=e[n].steps[a].index;if(o<i)return!1;i=o}}else for(var p=0;p<e[s].steps.length;p++)if(e[s].steps[p].syspreset){var l=100*e[s].steps[p].index+e[s].steps[p].bitindex;if(l<i)return!1;i=l}return!0},t.prototype.getDataPosition=function(t){var e=null,s=null,i=null,n=null;if($(t).hasClass("step-item"))for(var a=t.parentElement,o=a.className.split(" ")[1].split("-")[2],p=a.parentElement.parentElement.parentElement.className.split(" ")[1],l=Number(p.split("_")[1]),r=0;r<this.data.data[l-1].steps.length;r++){var d=this.data.data[l-1].steps[r];if(d.id==o){e=l-1,s=r,i=d,n="step";break}}else{var c=t.parentElement.className.split(" ")[1];e=Number(c.split("_")[1])-1,i=this.data.data[e],n="phase"}return{type:n,phaseIndex:e,stepIndex:s,data:i}},window.KdWtcStepConfig=t}();