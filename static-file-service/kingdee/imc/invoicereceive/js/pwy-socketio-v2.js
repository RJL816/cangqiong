var hexcase=0;function hex_md5(b){return rstr2hex(rstr_md5(str2rstr_utf8(b)))}function hex_hmac_md5(d,c){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(d),str2rstr_utf8(c)))}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(b){return binl2rstr(binl_md5(rstr2binl(b),b.length*8))}function rstr_hmac_md5(n,k){var l=rstr2binl(n);if(l.length>16){l=binl_md5(l,n.length*8)}var i=Array(16),m=Array(16);for(var h=0;h<16;h++){i[h]=l[h]^909522486;m[h]=l[h]^1549556828}var j=binl_md5(i.concat(rstr2binl(k)),512+k.length*8);return binl2rstr(binl_md5(m.concat(j),512+128))}function rstr2hex(l){try{hexcase}catch(i){hexcase=0}var j=hexcase?"0123456789ABCDEF":"0123456789abcdef";var e="";var h;for(var k=0;k<l.length;k++){h=l.charCodeAt(k);e+=j.charAt((h>>>4)&15)+j.charAt(h&15)}return e}function str2rstr_utf8(j){var f="";var i=-1;var g,h;while(++i<j.length){g=j.charCodeAt(i);h=i+1<j.length?j.charCodeAt(i+1):0;if(55296<=g&&g<=56319&&56320<=h&&h<=57343){g=65536+((g&1023)<<10)+(h&1023);i++}if(g<=127){f+=String.fromCharCode(g)}else{if(g<=2047){f+=String.fromCharCode(192|((g>>>6)&31),128|(g&63))}else{if(g<=65535){f+=String.fromCharCode(224|((g>>>12)&15),128|((g>>>6)&63),128|(g&63))}else{if(g<=2097151){f+=String.fromCharCode(240|((g>>>18)&7),128|((g>>>12)&63),128|((g>>>6)&63),128|(g&63))}}}}}return f}function rstr2binl(d){var e=Array(d.length>>2);for(var f=0;f<e.length;f++){e[f]=0}for(var f=0;f<d.length*8;f+=8){e[f>>5]|=(d.charCodeAt(f/8)&255)<<(f%32)}return e}function binl2rstr(d){var e="";for(var f=0;f<d.length*32;f+=8){e+=String.fromCharCode((d[f>>5]>>>(f%32))&255)}return e}function binl_md5(a,q){a[q>>5]|=128<<((q)%32);a[(((q+64)>>>9)<<4)+14]=q;var b=1732584193;var c=-271733879;var d=-1732584194;var i=271733878;for(var t=0;t<a.length;t+=16){var r=b;var s=c;var u=d;var v=i;b=md5_ff(b,c,d,i,a[t+0],7,-680876936);i=md5_ff(i,b,c,d,a[t+1],12,-389564586);d=md5_ff(d,i,b,c,a[t+2],17,606105819);c=md5_ff(c,d,i,b,a[t+3],22,-1044525330);b=md5_ff(b,c,d,i,a[t+4],7,-176418897);i=md5_ff(i,b,c,d,a[t+5],12,1200080426);d=md5_ff(d,i,b,c,a[t+6],17,-1473231341);c=md5_ff(c,d,i,b,a[t+7],22,-45705983);b=md5_ff(b,c,d,i,a[t+8],7,1770035416);i=md5_ff(i,b,c,d,a[t+9],12,-1958414417);d=md5_ff(d,i,b,c,a[t+10],17,-42063);c=md5_ff(c,d,i,b,a[t+11],22,-1990404162);b=md5_ff(b,c,d,i,a[t+12],7,1804603682);i=md5_ff(i,b,c,d,a[t+13],12,-40341101);d=md5_ff(d,i,b,c,a[t+14],17,-1502002290);c=md5_ff(c,d,i,b,a[t+15],22,1236535329);b=md5_gg(b,c,d,i,a[t+1],5,-165796510);i=md5_gg(i,b,c,d,a[t+6],9,-1069501632);d=md5_gg(d,i,b,c,a[t+11],14,643717713);c=md5_gg(c,d,i,b,a[t+0],20,-373897302);b=md5_gg(b,c,d,i,a[t+5],5,-701558691);i=md5_gg(i,b,c,d,a[t+10],9,38016083);d=md5_gg(d,i,b,c,a[t+15],14,-660478335);c=md5_gg(c,d,i,b,a[t+4],20,-405537848);b=md5_gg(b,c,d,i,a[t+9],5,568446438);i=md5_gg(i,b,c,d,a[t+14],9,-1019803690);d=md5_gg(d,i,b,c,a[t+3],14,-187363961);c=md5_gg(c,d,i,b,a[t+8],20,1163531501);b=md5_gg(b,c,d,i,a[t+13],5,-1444681467);i=md5_gg(i,b,c,d,a[t+2],9,-51403784);d=md5_gg(d,i,b,c,a[t+7],14,1735328473);c=md5_gg(c,d,i,b,a[t+12],20,-1926607734);b=md5_hh(b,c,d,i,a[t+5],4,-378558);i=md5_hh(i,b,c,d,a[t+8],11,-2022574463);d=md5_hh(d,i,b,c,a[t+11],16,1839030562);c=md5_hh(c,d,i,b,a[t+14],23,-35309556);b=md5_hh(b,c,d,i,a[t+1],4,-1530992060);i=md5_hh(i,b,c,d,a[t+4],11,1272893353);d=md5_hh(d,i,b,c,a[t+7],16,-155497632);c=md5_hh(c,d,i,b,a[t+10],23,-1094730640);b=md5_hh(b,c,d,i,a[t+13],4,681279174);i=md5_hh(i,b,c,d,a[t+0],11,-358537222);d=md5_hh(d,i,b,c,a[t+3],16,-722521979);c=md5_hh(c,d,i,b,a[t+6],23,76029189);b=md5_hh(b,c,d,i,a[t+9],4,-640364487);i=md5_hh(i,b,c,d,a[t+12],11,-421815835);d=md5_hh(d,i,b,c,a[t+15],16,530742520);c=md5_hh(c,d,i,b,a[t+2],23,-995338651);b=md5_ii(b,c,d,i,a[t+0],6,-198630844);i=md5_ii(i,b,c,d,a[t+7],10,1126891415);d=md5_ii(d,i,b,c,a[t+14],15,-1416354905);c=md5_ii(c,d,i,b,a[t+5],21,-57434055);b=md5_ii(b,c,d,i,a[t+12],6,1700485571);i=md5_ii(i,b,c,d,a[t+3],10,-1894986606);d=md5_ii(d,i,b,c,a[t+10],15,-1051523);c=md5_ii(c,d,i,b,a[t+1],21,-2054922799);b=md5_ii(b,c,d,i,a[t+8],6,1873313359);i=md5_ii(i,b,c,d,a[t+15],10,-30611744);d=md5_ii(d,i,b,c,a[t+6],15,-1560198380);c=md5_ii(c,d,i,b,a[t+13],21,1309151649);b=md5_ii(b,c,d,i,a[t+4],6,-145523070);i=md5_ii(i,b,c,d,a[t+11],10,-1120210379);d=md5_ii(d,i,b,c,a[t+2],15,718787259);c=md5_ii(c,d,i,b,a[t+9],21,-343485551);b=safe_add(b,r);c=safe_add(c,s);d=safe_add(d,u);i=safe_add(i,v)}return Array(b,c,d,i)}function md5_cmn(a,j,k,l,b,i){return safe_add(bit_rol(safe_add(safe_add(j,a),safe_add(l,i)),b),k)}function md5_ff(l,m,a,b,n,c,d){return md5_cmn((m&a)|((~m)&b),l,m,n,c,d)}function md5_gg(l,m,a,b,n,c,d){return md5_cmn((m&b)|(a&(~b)),l,m,n,c,d)}function md5_hh(l,m,a,b,n,c,d){return md5_cmn(m^a^b,l,m,n,c,d)}function md5_ii(l,m,a,b,n,c,d){return md5_cmn(a^(m|(~b)),l,m,n,c,d)}function safe_add(f,g){var h=(f&65535)+(g&65535);var e=(f>>16)+(g>>16)+(h>>16);return(e<<16)|(h&65535)}function bit_rol(d,c){return(d<<c)|(d>>>(32-c))}Function.prototype.method=function(a,b){if(!this.prototype[a]){this.prototype[a]=b
}return this};Array.method("indexOf",function(c){var b,a=this.length;for(b=0;b<a;b++){if(this[b]===c){return b}}return -1});function pwySocketIo(d,b){this.io=window.io||b;this.onError=d.onError||function(){};this.fromType=d.fromType||"third";this.sourceType=d.sourceType||"socket";var a=["socket","polling"];if(!typeof window.postMessage==="function"){a=["socket","polling"]}if(d.name!=""){this.transports=window.WebSocket?d.transports||a:["polling"];this.name=hex_md5(d.name);this.client_id=d.client_id||"vc0c6hjlgnKCic";this.tin=d.tin||"440301999999980";this.sign=d.sign||"7158858eb2ee6b36381e85a6279b153d";this.timestamp=d.timestamp||"1556262656725";this.eid=d.eid||"eid";var e=d.env||"old";if(e==="local"){this.baseApiUrl=d.apiUrl||"http://172.18.5.39:9104";this.url=d.url||"http://172.18.5.39:9092";this.path=d.path||""}else{if(e==="prod"){this.baseApiUrl=d.apiUrl||"https://api.piaozone.com";this.url=d.url||"https://link.piaozone.com";this.path=d.path||""}else{if(e==="test"){this.baseApiUrl=d.apiUrl||"https://api-dev.piaozone.com/test";this.url=d.url||"https://link-test.piaozone.com";this.path=d.path||""}else{if(e==="aws-test"){this.baseApiUrl=d.apiUrl||"https://aws.piaozone.com/api";this.url=d.url||"https://aws.piaozone.com";this.path=d.path||"/link/socket.io"}else{if(e==="tx-test"){this.baseApiUrl=d.apiUrl||"https://api-test.piaozone.com";this.url=d.url||"https://api-test.piaozone.com";this.path=d.path||"/link/socket.io"}else{if(e==="demo"){this.baseApiUrl=d.apiUrl||"https://api-dev.piaozone.com";this.url=d.url||"https://link.piaozone.com";this.path=d.path||""}else{if(e==="dev"){this.baseApiUrl=d.apiUrl||"http://172.18.5.39:9104";this.url=d.url||"http://172.18.5.39:9092";this.path=d.path||"";this.sign="8ec553845166a8c7b888fbcab0d00493"}else{this.baseApiUrl=d.apiUrl||"https://api.piaozone.com";this.url=d.url||"https://wss.piaozone.com";this.path=d.path||"/bill-ws/socket.io";this.name=d.name;this.transports=["socket"]}}}}}}}this.socketIoTransports=d.socketIoTransports||["websocket","polling"];this.onOpen=d.onOpen||function(){};this.onClose=d.close||function(){};this.retryFlag=true;this.ws=null;this.socketConnected=false;this.isPolling=false;this.pollingRequest=false;this.socketRetryTimes=0;this.socketRetryMaxTimes=3;this.pongTimeoutNum=0;this.pongTimeoutMaxNum=3;this.defaultPingTimeout=5000;this.receivedMessage=[];this.debug=(d.debug===true)?true:false;var c=this;this.onMessage=function(h,g,f){typeof d.onMessage==="function"&&d.onMessage(h,g,f)};this.getToken(function(f){if(f.errcode!=="0000"){c.onError("获取token异常","0025710000007401")}else{if(typeof c.io==="undefined"||c.sourceType==="polling"){c.startPolling(true)}else{if(c.transports.indexOf("socket")!==-1){c.init()}else{if(c.transports.indexOf("polling")!==-1){c.startPolling(true)}}}}})}else{this.onError("参数不完整","0025710000007400")}}pwySocketIo.prototype={md5:function(a){return hex_md5(a)},getToken:function(c){var b=this.baseApiUrl+"/base/fpzs/polling/oauth/token?client_id="+this.client_id+"&tin="+this.tin+"&sign="+this.sign+"&timestamp="+this.timestamp+"&eid="+encodeURIComponent(this.eid);var a=this;this.sendJsonp(b+"&jsonpCallback=?",function(d){if(d.errcode==="0000"){a.access_token=d.access_token}else{a.consoleLog("获取token异常：",d)}c(d)},function(d){c({"errcode":"tokenErr","description":"获取token出错"})})},pollingReply:function(c,b){var a=this;var d=this.baseApiUrl+"/polling/fpzs/portal/receipt?access_token="+this.access_token+"&key="+encodeURIComponent(this.name)+"&msgId="+c;this.consoleLog("开始消息服务端回复");this.sendJsonp(d+"&jsonpCallback=?",function(e){a.consoleLog("消息服务端回复成功");typeof b==="function"&&b()},function(e){a.consoleLog("消息服务端回复失败");typeof b==="function"&&b()})},getUUId:function(){var b=new Date().getTime();var a="xxxxxxxx-xxxx-xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(b+Math.random()*16)%16|0;b=Math.floor(b/16);return(e=="x"?d:(d&3|8)).toString(16)});return a},getShortUUId:function(){var b=new Date().getTime();var a="xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(b+Math.random()*16)%16|0;b=Math.floor(b/16);return(e=="x"?d:(d&3|8)).toString(16)});return a},consoleLog:function(b,a){if(this.debug&&window.console){if(typeof a==="undefined"){window.console.log(b)}else{window.console.log(b,a)}}},consoleWarn:function(a){if(window.console){window.console.warn(a)}},consoleError:function(a){if(window.console){window.console.error(a)}},handlerMsg:function(c,b){var a=this;if(typeof c!=="undefined"){if(a.receivedMessage.indexOf(c)===-1){a.receivedMessage.push(c);a.pollingReply(c);typeof b==="function"&&b()}else{a.pollingReply(c);typeof b==="function"&&b()}}else{typeof b==="function"&&b()}},sendJsonp:function(c,b,g){var a=this;var f=("jsonp_"+Math.random()).replace(".","");var e=document.getElementsByTagName("head")[0];var d=document.createElement("script");e.appendChild(d);window[f]=function(h){e.removeChild(d);clearTimeout(d.timer);window[f]=null;typeof b==="function"&&b(h)};d.src=c.replace(/\?$/,f);d.timer=setTimeout(function(){window[f]=null;e.removeChild(d);
a.consoleError("jsonp 请求超时",c);typeof g==="function"&&g({"errcode":"timeout","description":"请求超时"})},50000)},startPolling:function(c){var b=this;if(!b.isPolling){b.consoleLog("开始执行轮询");b.isPolling=true;b.socketConnected=false;b.onOpen(b.name,"0025710000007402")}if(b.pollingRequest){b.pollingRequest.abort()}var a=b.baseApiUrl+"/polling/fpzs/portal/invoice/data/v2?access_token="+b.access_token+"&key="+encodeURIComponent(b.name)+"&jsonpCallback=?";b.pollingRequest=this.sendJsonp(a,function(f){var g=f.errcode;if(g=="1300"){setTimeout(function(){b.getToken(function(h){if(h.errcode==="0000"){b.startPolling(false)}else{b.onError(h.description,"0025710000007401",h.errcode)}})},30000)}else{if(g=="1307"||g==="0000"){if(g==="0000"||f.data){b.consoleLog("接收到轮询消息：",f);var e=f.data.data;var d=f.data.msgId;if(b.receivedMessage.indexOf(d)===-1){b.onMessage(e,function(h){b.consoleError("新版socket库不支持前端直接回复消息，请通过api接口进行消息回复")},function(h){b.consoleError("新版socket库不支持前端直接回复消息，请通过api接口进行消息回复")})}b.handlerMsg(d,function(){b.startPolling(false)})}else{b.startPolling(false)}}else{setTimeout(function(){b.startPolling(false)},30000)}}},function(d,f){if(d.statusText!=="abort"){b.consoleLog("轮询时发送网络或者服务器异常, 延时2秒后重新轮询");b.consoleLog(d,f);setTimeout(function(){b.startPolling(false)},2000)}})},retryConnect:function(c,b){var a=this;a.consoleLog(a.socketRetryTimes);if(a.socketRetryTimes>=a.socketRetryMaxTimes){a.consoleLog("start polling");if(a.ws){a.ws.close()}a.socketRetryTimes=0;if(!a.isPolling){this.pongTimeoutNum=0;a.startPolling(true)}}else{this.pongTimeoutNum=0;a.socketRetryTimes+=1;if(a.ws){a.ws.close();a.ws.open()}}},onPingTimeout:function(){var a=this;if(a.transports.indexOf("polling")!==-1){if(this.pongTimeoutNum<this.pongTimeoutMaxNum){this.pongTimeoutNum+=1;a.consoleLog("ping TimeOut次数"+this.pongTimeoutNum)}else{if(a.ws){a.ws.close()}a.socketRetryTimes=0;if(!a.isPolling){this.pongTimeoutNum=0;a.startPolling(true)}}}else{a.consoleLog("已经禁用长轮询")}},onListenMessage:function(b,c){var a=this;if(typeof b.data==="string"){b.data=JSON.parse(b.data)}if(b.errcode==="0000"){if(b.data.eventType==="ping"){typeof c==="function"&&c(b)}else{a.consoleLog("接收到socket消息：",b);if(a.receivedMessage.indexOf(b.data.msgId)==-1){a.onMessage(b.data.data,function(d){var e=d.errcode||"0000";d.errcode=e;typeof c==="function"&&c(d)},function(d){typeof c==="function"&&c(d)})}if(b.data&&b.data.msgId){a.handlerMsg(b.data.msgId)}}}else{typeof c==="function"&&c(b)}},init:function(b){var a=this;if(typeof b!=="undefined"&&b!==this.name){this.name=b}this.ws=this.io(this.url,{path:this.path,autoConnect:false,query:{room:"cloud",userId:this.name},pingInterval:30000,pingTimeout:30000,transports:this.socketIoTransports});this.ws.on("connect_failed",a.retryConnect.bind(a));this.ws.on("connect_error",a.retryConnect.bind(a));this.ws.on("connect_timeout",a.retryConnect.bind(a));this.ws.on("connect",function(){a.consoleLog("socket连接成功: "+a.name);a.ws.on(a.ws.id,a.onListenMessage.bind(a));a.ws.on(decodeURIComponent(a.name),a.onListenMessage.bind(a));a.socketConnected=true;a.pongTimeoutNum=0;a.onOpen(a.name,"0025710000007402");a.startPingPongCheck()});this.ws.on("error",function(c){a.consoleLog("推送服务发送异常",c);a.onError("推送服务发送异常","0025710000007401")});this.ws.on("disconnect",function(c){a.consoleLog("socket连接断开");a.socketConnected=false});this.ws.open()},sendPing:function(){var a=this;var b=a.defaultPingTimeout||2000;var d=+new Date();var c=false;a.ws.emit("server",{target:a.name,msg:JSON.stringify({eventType:"ping",data:d})},function(f){if(document.hidden){a.consoleLog("页面当前不可见，忽略超时")}else{c=+new Date();var e=c-d;if(f.errcode==="0000"){if(e>b){a.consoleLog("ping 超时，耗时："+e);a.onPingTimeout()}else{a.pongTimeoutNum=0;a.consoleLog("ping 正常，耗时："+e+"， pingTime: "+(d/1000))}return false}else{a.consoleLog("ping 异常："+f.description);a.consoleLog("ping name："+a.name);a.onPingTimeout();return false}}});if(!document.hidden){setTimeout(function(){if(!c){a.consoleLog("ping 超时，500ms 内无回复，");a.onPingTimeout()}return false},b>500?b:500)}else{a.consoleLog("页面当前不可见，忽略超时")}},startPingPongCheck:function(){var a=this;if(a.socketConnected){a.sendPing()}a.pingTick=setTimeout(function(){a.startPingPongCheck()},15000)},stopPolling:function(){this.isPolling=false;if(this.pollingRequest){this.pollingRequest.abort()}},close:function(){this.stopPolling();window.clearTimeout(this.pingTick);this.ws.close()},sendNew:function(c,a,g){var g=g||(+new Date());var b=c.url||"";var j=this;var h=c.to||"";var d=c.msg||"";var i=c.success||function(){};var e=c.error||this.onError;var f=c.timeOut||15;a=a||3;if(h===""){e("请指定发送的目标用户名","0025710000007407");return false}if(d===""){e("请指定需要发送的消息！","0025710000007408");return false}if(this.ws){this.ws.emit("server",{sid:j.name+"-"+(+new Date())+"-"+Math.random(),msgId:(+new Date())+j.getShortUUId,async:false,from:j.name,target:h,msg:JSON.stringify(d),timeOut:c.timeOut||20},function(k){if(k.errcode==="0000"){i(k)}else{var m=+new Date();if(m-g>f*1000){var l=k.description||"推送异常";j.consoleLog("target",h);
j.consoleLog("from",j.name);j.consoleLog("msg",d);e("请求超时, "+l)}else{if(k.errcode==="connectErr"){setTimeout(function(){j.sendNew(c,a-1,g)},1500)}else{var l=k.description||"推送异常";e(l)}}}})}else{e("未连接到推送服务","0025710000007409")}}};window.pwySocketIo=pwySocketIo;window.PwyWebSocket=pwySocketIo;
